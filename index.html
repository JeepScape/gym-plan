
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Sunday-Start Plan</title>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{
      --bg:#0c1116;
      --card:#121823;
      --text:#e8ecf1;
      --muted:#9fb1c1;
      --accent:#74c0fc;
      --accent-weak:#2b5e87;
      --outline:#3b82f6;
      --ok:#34d399;
      --border:#223045;
      --shadow: 0 6px 24px rgba(0,0,0,.35);
    }
    :root.light{
      --bg:#f8fafc;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#4b5563;
      --accent:#2563eb;
      --accent-weak:#dbeafe;
      --outline:#2563eb;
      --ok:#059669;
      --border:#e5e7eb;
      --shadow: 0 6px 20px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
      background:var(--bg);
      color:var(--text);
      padding-top: calc(env(safe-area-inset-top) + 18px); /* more space for bezel */
    }
    .wrap{max-width:820px;margin:0 auto;padding:16px}
    h1{font-size:clamp(24px,4.5vw,34px);margin:0 0 6px 0;line-height:1.1}
    .subtitle{color:var(--muted);margin-bottom:18px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px}
    .btn{
      background:var(--card);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 14px;
      box-shadow:var(--shadow);
      cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:var(--shadow);margin:12px 0}
    .section-title{font-weight:700;font-size:18px;margin-bottom:8px}
    .week-h{color:var(--muted);font-weight:600;margin:8px 0 2px}
    .day{border:1px dashed var(--border);border-radius:18px;padding:14px;margin:10px 0;position:relative}
    .day.today{outline:2px solid var(--outline); box-shadow:0 0 0 4px color-mix(in oklab, var(--outline) 25%, transparent);}
    .day-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:8px}
    .date{color:var(--muted);font-weight:600}
    .wtitle{font-weight:800;font-size:18px}
    .ex{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;padding:12px 0;border-top:1px dashed var(--border)}
    .ex:first-of-type{border-top:0}
    .ex .name{font-weight:600}
    .ex .reps{color:var(--muted);font-variant-numeric:tabular-nums}
    .vid{border:1px solid var(--border);background:transparent;color:var(--text);padding:8px 10px;border-radius:10px}
    .chk{width:22px;height:22px;accent-color:var(--ok)}
    .muted{color:var(--muted)}
    .sticky-today{position:sticky;top:calc(env(safe-area-inset-top) + 6px);z-index:3}
    .note{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 id="title">Sunday-Start Plan</h1>
    <div class="subtitle">Goal: rebuild strength + trim belly (incline walks). Keep 1–3 reps in reserve.</div>
    <div class="row">
      <button id="prev" class="btn">◀ Prev Week</button>
      <button id="next" class="btn">Next Week ▶</button>
      <button id="todayBtn" class="btn">Today</button>
      <button id="themeBtn" class="btn">Theme</button>
    </div>

    <div id="fitness" class="card">
      <div class="section-title">Today · Apple Fitness</div>
      <div id="fitnessBody" class="muted">Loading…</div>
    </div>

    <div id="weeks"></div>
    <div class="card note">Checkboxes save on this device. Videos open in a new tab. Theme toggle persists.</div>
  </div>

<script>
(function(){
  // ----- Theme -----
  const root = document.documentElement;
  const savedTheme = localStorage.getItem('theme');
  if(savedTheme){ root.classList.toggle('light', savedTheme==='light'); }
  else {
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches){
      root.classList.add('light');
    }
  }
  document.getElementById('themeBtn').onclick = () => {
    root.classList.toggle('light');
    localStorage.setItem('theme', root.classList.contains('light') ? 'light' : 'dark');
  };

  // ----- Utilities -----
  const fmtDate = (d) => d.toISOString().slice(0,10);
  const parseISO = (s) => new Date(s + 'T00:00:00');
  const todayStr = fmtDate(new Date());

  const byId = (id)=>document.getElementById(id);
  const weeksEl = byId('weeks');
  let PLAN = null;
  let currentWeekIndex = 0;
  let todayAnchorId = null;

  // ----- Fitness card -----
  fetch('fitness.json', {cache:'no-store'})
    .then(r=>r.ok?r.json():null)
    .then(j=>{
      if(!j) throw 0;
      const w = (j.workouts && j.workouts.length) ? ('<br>Workouts:<br>• '+ j.workouts.map(w=>w.type + ' · ' + (w.minutes||w.duration||0)+' min').join('<br>• ') ) : '—';
      byId('fitnessBody').innerHTML =
        `<strong>${j.date||todayStr}</strong><br>`+
        `Steps: ${j.steps?.toLocaleString?.()||0} · Distance: ${(j.distance_km||0).toFixed(2)} km<br>`+
        `Active: ${j.active_energy_kcal||0} kcal · Exercise: ${j.exercise_minutes||0} min<br>`+
        `${w}`;
    })
    .catch(_=>{ byId('fitnessBody').textContent='—'; });

  // ----- Load plan -----
  fetch('plan.json', {cache:'no-store'})
    .then(r=>r.json())
    .then(plan=>{
      PLAN = plan;
      render();
    }).catch(e=>{
      weeksEl.innerHTML = '<div class="card">Could not load plan.json</div>';
    });

  // Robust getWeeks from various shapes
  function getWeeks(p){
    if (Array.isArray(p.weeks)) return p.weeks;
    if (Array.isArray(p) && p.length && p[0].days) return p;
    if (Array.isArray(p.days)){ // flat days -> chunk into 7s by date week
      const groups = {};
      p.days.forEach(d=>{
        const ds = d.date;
        const weekStart = startOfWeek(parseISO(ds));
        const key = fmtDate(weekStart);
        (groups[key] ||= {start:key, days:[]}).days.push(d);
      });
      return Object.values(groups).sort((a,b)=>a.start.localeCompare(b.start));
    }
    return [];
  }

  function startOfWeek(date){
    // Sunday start
    const d = new Date(date);
    const day = d.getDay(); // 0 Sun
    d.setDate(d.getDate()-day);
    d.setHours(0,0,0,0);
    return d;
  }

  function weekIndexForToday(weeks){
    const t = parseISO(todayStr);
    for (let i=0;i<weeks.length;i++){
      const w = weeks[i];
      const dates = (w.days||[]).map(d=>d.date);
      if(!dates.length) continue;
      const start = parseISO(dates[0]);
      const end = parseISO(dates[dates.length-1]);
      if (t >= start && t <= end) return i;
    }
    // fallback: closest past week
    let idx = 0, minDelta = Infinity;
    for(let i=0;i<weeks.length;i++){
      const last = parseISO((weeks[i].days||[]).slice(-1)[0]?.date || weeks[i].start);
      const delta = Math.abs(last - t);
      if (delta < minDelta){ minDelta = delta; idx = i; }
    }
    return idx;
  }

  function idFor(date,name){
    return `ex|${date}|${name}`.toLowerCase().replace(/\s+/g,'_');
  }

  function render(){
    const weeks = getWeeks(PLAN);
    if(!weeks.length){
      weeksEl.innerHTML = '<div class="card">No weeks in plan.json</div>';
      return;
    }
    currentWeekIndex = weekIndexForToday(weeks);

    const draw = (i)=>{
      const w = weeks[i];
      const start = parseISO((w.days||[])[0].date);
      const end   = parseISO((w.days||[]).slice(-1)[0].date);
      const head = `<div class="week-h">Week ${i+1} · ${start.toLocaleDateString(undefined,{day:'2-digit',month:'short'})} — ${end.toLocaleDateString(undefined,{day:'2-digit',month:'short'})}</div>`;
      let html = head + `<div class="card">`;

      todayAnchorId = null;
      (w.days||[]).forEach(day=>{
        const isToday = day.date===todayStr;
        const anchor = isToday ? (todayAnchorId = `day-${day.date}`) : '';
        html += `<div class="day ${isToday?'today':''}" id="${anchor}">` +
                  `<div class="day-top"><div class="wtitle">${day.title || day.name || ''}</div>`+
                  `<div class="date">${new Date(day.date+'T00:00:00').toLocaleDateString(undefined,{weekday:'short', day:'2-digit', month:'short'})}</div></div>`;

        if (Array.isArray(day.exercises)){
          day.exercises.forEach(ex=>{
            const exName = ex.name || ex.title || 'Exercise';
            const reps = ex.reps || ex.rep_range || ex.range || '';
            const vid = ex.video || ex.vimeo || ex.url || '';
            const key = idFor(day.date, exName);
            const checked = localStorage.getItem(key)==='1' ? 'checked' : '';
            html += `<div class="ex">`+
                      `<div><div class="name">${exName}</div>`+
                      `<div class="reps muted">${reps}</div></div>`+
                      `<div>`+(vid?`<a class="vid" href="${vid}" target="_blank" rel="noopener">Video</a>`:`<span class="muted">No video</span>`)+`</div>`+
                      `<div><input type="checkbox" class="chk" data-k="${key}" ${checked}></div>`+
                    `</div>`;
          });
        } else {
          html += `<div class="muted">No exercises</div>`;
        }
        html += `</div>`;
      });
      html += `</div>`;
      weeksEl.innerHTML = html;

      // Wire checkboxes
      weeksEl.querySelectorAll('input.chk').forEach(cb=>{
        cb.addEventListener('change', (e)=>{
          const k = e.target.dataset.k;
          if (e.target.checked) localStorage.setItem(k,'1'); else localStorage.removeItem(k);
        });
      });

      // Auto-scroll to today
      if (todayAnchorId){
        const el = document.getElementById(todayAnchorId);
        if (el) { setTimeout(()=> el.scrollIntoView({behavior:'smooth', block:'start'}), 100); }
      }
    };

    draw(currentWeekIndex);
    document.getElementById('prev').onclick = ()=>{
      currentWeekIndex = Math.max(0, currentWeekIndex-1); draw(currentWeekIndex);
    };
    document.getElementById('next').onclick = ()=>{
      currentWeekIndex = Math.min(weeks.length-1, currentWeekIndex+1); draw(currentWeekIndex);
    };
    document.getElementById('todayBtn').onclick = ()=>{
      currentWeekIndex = weekIndexForToday(weeks); draw(currentWeekIndex);
    };
  }
})();
</script>
</body>
</html>
