<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>6-Month Sunday-Start Plan</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b1220">
  <style>
    :root{
      color-scheme: light dark;
      --bg:#0b1220; --card:#121a2a; --text:#e6eefc; --muted:#a9b2c3; --accent:#7de0b5; --border:#2a3550;
    }
    [data-theme="light"]{
      --bg:#f7f9ff; --card:#ffffff; --text:#0a1120; --muted:#4c556a; --accent:#2f8fdd; --border:#dfe6f3;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font:16px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      padding:calc(env(safe-area-inset-top) + 18px) 14px 28px 14px;
    }
    .wrap{max-width:900px;margin:0 auto;}
    h1{margin:0 0 6px 0;font-size:clamp(22px,4.5vw,36px);}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;margin:18px 0;align-items:center;flex-wrap:wrap}
    .btn{background:var(--card);border:1px solid var(--border);padding:10px 14px;border-radius:12px;color:var(--text);}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-top:16px;}
    .title{margin-bottom:8px}
    .small{font-size:12px;color:var(--muted)}
    .day{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;border:1px dashed var(--border);border-radius:12px;padding:12px;margin:8px 0;}
    .day.today{outline:2px solid var(--accent);}
    .toggle input{width:22px;height:22px}
    a{color:var(--accent);text-decoration:none}
    input[type="number"]{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px;width:120px}
    .calc-grid{display:grid;grid-template-columns: 1fr 1fr;gap:10px;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>6-Month Sunday-Start Plan</h1>
    <div class="muted">Plan generated from your Excel workouts. Incline/mobility only outside the sheet.</div>

    <div class="row">
      <button id="prev" class="btn">◀ Prev Week</button>
      <button id="next" class="btn">Next Week ▶</button>
      <button id="todayBtn" class="btn">Today</button>
      <button id="theme" class="btn" style="margin-left:auto">Theme</button>
    </div>

    <div class="card"><div id="fit-card" class="title">Loading…</div></div>

    <div id="week" class="card"></div>

    <div class="card">
      <div class="title"><b>Protein Calculator</b></div>
      <div class="calc-grid">
        <label>Weight (kg)<br><input id="kg" type="number" inputmode="decimal" step="0.1" value="88"></label>
        <label>Target (g/kg)<br><input id="ppk" type="number" inputmode="decimal" step="0.1" value="1.8"></label>
      </div>
      <div class="small" id="pOut" style="margin-top:8px">—</div>
      <div class="small" style="margin-top:8px">
        On appetite-suppressing meds, aim for <b>~1.6–2.0 g/kg</b> (e.g., 140–176 g/day at 88 kg). Distribute across 3–4 meals (25–45 g each) and include whole-food protein (eggs, Greek yogurt, fish/chicken, tofu/legumes). Hydrate and add extra salt if needed for fullness. This is general guidance only.
      </div>
    </div>
  </div>

<script>
/* --- Theme toggle --- */
(function(){
  const saved = localStorage.getItem('theme');
  if(saved) document.documentElement.setAttribute('data-theme', saved);
  document.getElementById('theme').onclick = () => {
    const curr = document.documentElement.getAttribute('data-theme')==='light'?'dark':'light';
    document.documentElement.setAttribute('data-theme', curr);
    localStorage.setItem('theme', curr);
  };
})();

/* --- helpers --- */
const $ = id=>document.getElementById(id);
const fmtDate = (iso)=>{
  const d = new Date(iso+'T00:00:00');
  return d.toLocaleDateString(undefined,{weekday:'short', day:'2-digit', month:'short'});
};

/* --- Protein calc --- */
(function(){
  const kg = $('kg'), ppk = $('ppk'), out = $('pOut');
  function calc(){
    const w = Math.max(0, parseFloat(kg.value||'0'));
    const r = Math.max(0, parseFloat(ppk.value||'0'));
    const grams = Math.round(w * r);
    out.innerHTML = `<b>${grams} g/day</b> · Range for 1.6–2.0 g/kg at ${w||0} kg: <b>${Math.round(w*1.6)}–${Math.round(w*2.0)} g</b>`;
  }
  kg.addEventListener('input', calc);
  ppk.addEventListener('input', calc);
  calc();
})();

/* --- Fitness card: live view only --- */
(async function(){
  try {
    const r = await fetch('./fitness.json?ts='+Date.now(), {cache:'no-store'});
    if(!r.ok) throw new Error('fitness.json fetch');
    const d = await r.json();
    const wk = (d.workouts||[]).map(w => `• ${w.type} · ${w.minutes} min`).join('<br>') || '—';
    const steps = (d.steps||0).toLocaleString();
    const distance = (d.distance_km!=null ? Number(d.distance_km).toFixed(2) : '0.00');
    const kcal = d.active_energy_kcal||0;
    const exMin = d.exercise_minutes||0;
    $('fit-card').innerHTML = `
      <div class="title"><b>Today · Apple Fitness</b></div>
      <div class="small">
        <b>${d.date||''}</b><br>
        Steps: ${steps} · Distance: ${distance} km<br>
        Active: ${kcal} kcal · Exercise: ${exMin} min<br>
        <span class="small">Workouts:</span><br>${wk}
      </div>`;
  } catch(e){
    $('fit-card').innerHTML = '<div class="small">Could not load fitness.json</div>';
  }
})();

/* --- Load plan and render with checkboxes & videos --- */
let PLAN=null, weekIndex=0;
const PROG_KEY='gp-progress-v1'; // per-day checkboxes
let progress={};
try{progress=JSON.parse(localStorage.getItem(PROG_KEY)||'{}')}catch{}

function dayKey(iso){ return iso; }

function renderWeek(idx){
  const w = PLAN.weeks[idx];
  const wrap = $('week');
  wrap.innerHTML = '<div class="small" style="margin-bottom:8px">'+w.label+'</div>';
  const todayIso = new Date().toISOString().slice(0,10);

  (w.days||[]).forEach(day=>{
    const key = dayKey(day.date);
    const done = !!progress[key];
    const exHtml = (day.exercises||[]).map(ex=>{
      const v = ex.video ? `<a class="small" href="${ex.video}" target="_blank" rel="noopener">video</a>` : '';
      const rep = ex.rep_range ? `<span class="small" style="opacity:.8">(${ex.rep_range})</span>` : '';
      return `<div class="small">• ${ex.name||''} ${rep} ${v}</div>`;
    }).join('');
    const row = `
      <div class="day ${day.date===todayIso?'today':''}">
        <div class="title">
          <div><b>${fmtDate(day.date)}</b> · ${day.type||'Rest'}</div>
          ${day.notes?`<div class="small">${day.notes}</div>`:''}
          ${exHtml}
        </div>
        <label class="toggle">
          <input type="checkbox" ${done?'checked':''} onchange="toggleDone('${key}', this.checked)" aria-label="Mark ${day.date} complete">
        </label>
      </div>`;
    wrap.insertAdjacentHTML('beforeend', row);
  });

  const el = wrap.querySelector('.day.today');
  if(el){ el.scrollIntoView({behavior:'smooth', block:'center'}); }
  try{ localStorage.setItem(PROG_KEY, JSON.stringify(progress)); }catch{}
}
window.toggleDone = function(key, val){
  if(val) progress[key]=true; else delete progress[key];
  try{ localStorage.setItem(PROG_KEY, JSON.stringify(progress)); }catch{}
};

// Week navigation + Today button
document.getElementById('prev').onclick = ()=>{ weekIndex = Math.max(0, weekIndex-1); renderWeek(weekIndex); };
document.getElementById('next').onclick = ()=>{ weekIndex = Math.min((PLAN?.weeks?.length||1)-1, weekIndex+1); renderWeek(weekIndex); };
document.getElementById('todayBtn').onclick = ()=>{
  const today = new Date().toISOString().slice(0,10);
  let idx = PLAN.weeks.findIndex(w => {
    const start = new Date(w.start+'T00:00:00').getTime();
    const end = start + 6*86400000;
    const t = new Date(today+'T00:00:00').getTime();
    return t >= start && t <= end;
  });
  if(idx<0){
    const t = new Date(today+'T00:00:00').getTime();
    let best = 0, bestDiff = Infinity;
    PLAN.weeks.forEach((w,i)=>{
      const start = new Date(w.start+'T00:00:00').getTime();
      if(start <= t){
        const diff = t - start;
        if(diff < bestDiff){ bestDiff = diff; best = i; }
      }
    });
    idx = best;
  }
  weekIndex = idx;
  renderWeek(weekIndex);
};

(async function(){
  try {
    const res = await fetch('./plan.json?ts='+Date.now(), {cache:'no-store'});
    if(!res.ok) throw new Error('plan.json fetch');
    PLAN = await res.json();

    // initial week selection: today, else nearest past week
    const today = new Date().toISOString().slice(0,10);
    let idx = PLAN.weeks.findIndex(w => {
      const start = new Date(w.start+'T00:00:00').getTime();
      const end = start + 6*86400000;
      const t = new Date(today+'T00:00:00').getTime();
      return t >= start && t <= end;
    });
    if(idx<0){
      const t = new Date(today+'T00:00:00').getTime();
      let best = 0, bestDiff = Infinity;
      PLAN.weeks.forEach((w,i)=>{
        const start = new Date(w.start+'T00:00:00').getTime();
        if(start <= t){
          const diff = t - start;
          if(diff < bestDiff){ bestDiff = diff; best = i; }
        }
      });
      idx = best;
    }
    weekIndex = idx;
    renderWeek(weekIndex);
  } catch(e){
    $('week').innerHTML = '<div class="small">Could not load plan.json in repo root.</div>';
  }
})();

// Register SW: shell cached; JSON network-first
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./service-worker.js');
}
</script>
</body>
</html>
